name: ipsec_skillet

label: IPSEC Config Skillet

description: Skillet for configuring IKE Gateway and IPSEC tunnel

type: panos

labels:

    collection: Unknown

variables:

-   name: tunnel_interface_name
    description: tunnel_interface_name
    type_hint: text
    default: ''

-   name: tunnel_interface_description
    description: tunnel_interface_description
    type_hint: text
    default: ''

-   name: local_ip_address
    description: IP/CIDR of local interface
    type_hint: text
    default: ''
    help_text: ''

-   name: gateway_description
    description: gateway_description
    type_hint: text
    default: ''

-   name: local_interface
    description: local_interface
    type_hint: text
    default: ethernet1/1
    help_text: ''

-   name: gateway_name
    description: gateway_name
    type_hint: text
    default: ''

-   name: preshared_key
    description: preshared_key
    type_hint: text
    default: ''

-   name: peer_ip_address
    description: peer_ip_address
    type_hint: text
    default: ''

-   name: tunnel_name
    description: tunnel_name
    type_hint: text
    default: ''

-   name: tunnel_description
    description: tunnel_description
    type_hint: text
    default: ''

-   name: router_name
    description: router_name
    type_hint: text
    default: ''

-   name: remote_network_ip_cidr
    description: remote_network_ip_cidr
    type_hint: text
    default: ''

-   name: tunnel_route_name
    description: tunnel_route_name
    type_hint: text
    default: ''

-   name: nat_traversal
    description: nat_traversal
    type_hint: dropdown
    default: 'no'
    help_text: ''
    dd_list:
    -   key: 'Yes'
        value: 'yes'
    -   key: 'No'
        value: 'no'

-   name: passive_mode
    description: passive_mode
    type_hint: dropdown
    default: ''
    help_text: ''
    dd_list:
    -   key: 'Yes'
        value: 'yes'
    -   key: 'No'
        value: 'no'

snippets:

-   name: tunnel-455683
    xpath: /config/devices/entry[@name="localhost.localdomain"]/network/interface
    element: |-
        <tunnel>
          <units>
            <entry name="{{ tunnel_interface_name }}">
              <comment>{{ tunnel_interface_description }}</comment>
            </entry>
          </units>
        </tunnel>
    cmd: set

-   name: gateway-4662
    xpath: /config/devices/entry[@name="localhost.localdomain"]/network/ike
    element: |-
        <gateway>
          <entry name="{{ gateway_name }}">
            <authentication>
              <pre-shared-key>
                <key>{{ preshared_key }}</key>
              </pre-shared-key>
            </authentication>
            <protocol>
              <ikev1>
                <dpd>
                  <enable>yes</enable>
                </dpd>
              </ikev1>
              <ikev2>
                <dpd>
                  <enable>yes</enable>
                </dpd>
              </ikev2>
            </protocol>
            <local-address>
              <ip>{{ local_ip_address }}</ip>
              <interface>{{ local_interface }}</interface>
            </local-address>
            <protocol-common>
              <nat-traversal>
                <enable>{{ nat_traversal }}</enable>
              </nat-traversal>
              <fragmentation>
                <enable>no</enable>
              </fragmentation>
              <passive-mode>{{ passive_mode }}</passive-mode>
            </protocol-common>
            <peer-address>
              <ip>{{ peer_ip_address }}</ip>
            </peer-address>
            <comment>{{ gateway_description }}</comment>
          </entry>
        </gateway>
    cmd: set

-   name: tunnel-466695
    xpath: /config/devices/entry[@name="localhost.localdomain"]/network
    element: |-
        <tunnel>
          <ipsec>
            <entry name="{{ tunnel_name }}">
              <auto-key>
                <ike-gateway>
                  <entry name="{{ gateway_name}}"/>
                </ike-gateway>
              </auto-key>
              <tunnel-monitor>
                <enable>no</enable>
              </tunnel-monitor>
              <tunnel-interface>{{ tunnel_interface_name }}</tunnel-interface>
              <comment>{{ tunnel_description }}</comment>
              <disabled>no</disabled>
            </entry>
          </ipsec>
        </tunnel>
    cmd: set

-   name: routing-table-631221
    xpath: /config/devices/entry[@name="localhost.localdomain"]/network/virtual-router/entry[@name="{{
        router_name }}"]
    element: |-
        <routing-table>
          <ip>
            <static-route>
              <entry name="{{ tunnel_route_name }}">
                <bfd>
                  <profile>None</profile>
                </bfd>
                <interface>{{ tunnel_interface_name }}</interface>
                <metric>10</metric>
                <destination>{{ remote_network_ip_cidr }}</destination>
                <route-table>
                  <unicast/>
                </route-table>
              </entry>
            </static-route>
          </ip>
        </routing-table>
    cmd: set

